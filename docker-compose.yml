# =============================================================================
# NisFix Backend - Local Development Stack
# =============================================================================
#
# Usage:
#   make docker-compose-up    # Start all services
#   make docker-compose-down  # Stop all services
#   make docker-compose-logs  # View logs
#
# Or directly:
#   docker-compose up -d
#   docker-compose down
#   docker-compose logs -f

services:
  # ---------------------------------------------------------------------------
  # NisFix Backend API
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VERSION=${VERSION:-0.1.0-dev}
        - BUILD_TIME=${BUILD_TIME:-unknown}
        - GIT_COMMIT=${GIT_COMMIT:-unknown}
        - GIT_BRANCH=${GIT_BRANCH:-unknown}
    container_name: nisfix-api
    ports:
      - "8080:8080"
    environment:
      # Database
      - NISFIX_DATABASE_URI=mongodb://mongo:27017
      - NISFIX_DATABASE_NAME=nisfix
      # JWT
      - NISFIX_JWT_PRIVATE_KEY_PATH=/app/keys/private.pem
      - NISFIX_JWT_PUBLIC_KEY_PATH=/app/keys/public.pem
      - NISFIX_ACCESS_TOKEN_EXPIRY=1h
      - NISFIX_REFRESH_TOKEN_EXPIRY=720h
      # Mail Service (mailsendAPI integration - mock in development)
      - NISFIX_MAIL_BASE_URL=http://localhost:8000
      - NISFIX_MAIL_API_KEY=your32characterapikeygoeshere12
      - NISFIX_MAIL_SENDER_NAME=NisFix
      - NISFIX_MAIL_PROJECT=nisfix
      # Server
      - NISFIX_SERVER_PORT=8080
      - NISFIX_ENVIRONMENT=development
      # Magic Links
      - NISFIX_MAGIC_LINK_BASE_URL=http://localhost:3000
      - NISFIX_MAGIC_LINK_EXPIRY=15m
      - NISFIX_INVITATION_EXPIRY=168h
      # CORS
      - NISFIX_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001
      # Rate Limiting
      - NISFIX_RATE_LIMIT_REQUESTS=100
      - NISFIX_RATE_LIMIT_WINDOW=1m
    volumes:
      # Mount JWT keys from host
      - ./keys:/app/keys:ro
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/live"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # MongoDB Database
  # ---------------------------------------------------------------------------
  mongo:
    image: mongo:7.0
    container_name: nisfix-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
      - mongo_config:/data/configdb
    environment:
      # No authentication for development
      # Add MONGO_INITDB_ROOT_USERNAME/PASSWORD for production
      - MONGO_INITDB_DATABASE=nisfix
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Mongo Express - Web UI for MongoDB (development only)
  # ---------------------------------------------------------------------------
  mongo-express:
    image: mongo-express:1.0
    container_name: nisfix-mongo-express
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://mongo:27017
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=admin
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - tools

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mongo_data:
    name: nisfix_mongo_data
  mongo_config:
    name: nisfix_mongo_config
